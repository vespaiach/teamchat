import{c as b,h as L,i as _,j as W,k as V}from"./common-7IHFL5F2.js";import{a as i,b as u,d as A,k as a}from"./common-ATYGQR7Y.js";var R=i(a(),1);function z(t){return(0,R.jsx)("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",...t,children:(0,R.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}var v=i(u(),1);var l=i(a(),1),U={smaller:"w-8 h-8",small:"w-9 h-9",medium:"w-12 h-12",large:"w-22 h-22"};function J({user:t,size:e="small",online:n,className:o,onClick:r}){let[c,H]=(0,v.useState)(null);return(0,v.useEffect)(()=>{let M=new Image;M.onload=()=>{H(`/users/${t.id}/avatar`)},M.src=`/users/${t.id}/avatar`},[t]),(0,l.jsxs)("div",{"aria-label":`${t.name}'s avatar`,onClick:r,role:"img",className:A("flex items-center justify-center bg-stone-200 bg-cover bg-center shrink-0 rounded-full relative",U[e],o),children:[c&&(0,l.jsx)("img",{src:c,alt:`${t.name}'s avatar`,className:"object-cover object-center w-full h-full rounded-full border border-transparent"}),!c&&(0,l.jsx)("div",{className:"h-full w-full flex items-center justify-center text-sm font-medium text-white bg-primary dark:bg-primary-dark rounded-full",children:(0,l.jsxs)("span",{className:"text-xs font-medium",children:[t.firstName[0].toUpperCase(),t.lastName[0].toUpperCase()]})}),n!=null&&(0,l.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5",children:(0,l.jsx)("div",{className:A("w-3 h-3 rounded-full bg-green-500 border-2 border-white dark:border-gray-800",n?"bg-green-500":"bg-gray-400")})})]})}var D=i(a(),1);function q(t){return(0,D.jsx)("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",...t,children:(0,D.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}var O=i(a(),1);function F(){return(0,O.jsx)("div",{className:"w-2 h-2 rounded-full bg-primar"})}var G=i(a(),1);function Z(t){return(0,G.jsx)("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",...t,children:(0,G.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}var E=i(a(),1);function K(t){return(0,E.jsx)("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",...t,children:(0,E.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}var h=i(u(),1);function Q(){let[t,e]=(0,h.useState)([]),[n,o]=(0,h.useState)(!0);return(0,h.useEffect)(()=>{(async()=>{let r=await b("/conversations",{type:"direct"});r.success&&e(V(r.data)),o(!1)})()},[]),{setDirectChannels:e,directChannels:t,directChannelsLoading:n}}var k=i(u(),1);var C={logger:typeof console<"u"?console:void 0,WebSocket:typeof WebSocket<"u"?WebSocket:void 0},s={log(...t){this.enabled&&(t.push(Date.now()),C.logger.log("[ActionCable]",...t))}},p=()=>new Date().getTime(),S=t=>(p()-t)/1e3,f=class{constructor(e){this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=e,this.reconnectAttempts=0}start(){this.isRunning()||(this.startedAt=p(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),s.log(`ConnectionMonitor started. stale threshold = ${this.constructor.staleThreshold} s`))}stop(){this.isRunning()&&(this.stoppedAt=p(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),s.log("ConnectionMonitor stopped"))}isRunning(){return this.startedAt&&!this.stoppedAt}recordMessage(){this.pingedAt=p()}recordConnect(){this.reconnectAttempts=0,delete this.disconnectedAt,s.log("ConnectionMonitor recorded connect")}recordDisconnect(){this.disconnectedAt=p(),s.log("ConnectionMonitor recorded disconnect")}startPolling(){this.stopPolling(),this.poll()}stopPolling(){clearTimeout(this.pollTimeout)}poll(){this.pollTimeout=setTimeout(()=>{this.reconnectIfStale(),this.poll()},this.getPollInterval())}getPollInterval(){let{staleThreshold:e,reconnectionBackoffRate:n}=this.constructor,o=Math.pow(1+n,Math.min(this.reconnectAttempts,10)),c=(this.reconnectAttempts===0?1:n)*Math.random();return e*1e3*o*(1+c)}reconnectIfStale(){this.connectionIsStale()&&(s.log(`ConnectionMonitor detected stale connection. reconnectAttempts = ${this.reconnectAttempts}, time stale = ${S(this.refreshedAt)} s, stale threshold = ${this.constructor.staleThreshold} s`),this.reconnectAttempts++,this.disconnectedRecently()?s.log(`ConnectionMonitor skipping reopening recent disconnect. time disconnected = ${S(this.disconnectedAt)} s`):(s.log("ConnectionMonitor reopening"),this.connection.reopen()))}get refreshedAt(){return this.pingedAt?this.pingedAt:this.startedAt}connectionIsStale(){return S(this.refreshedAt)>this.constructor.staleThreshold}disconnectedRecently(){return this.disconnectedAt&&S(this.disconnectedAt)<this.constructor.staleThreshold}visibilityDidChange(){document.visibilityState==="visible"&&setTimeout(()=>{(this.connectionIsStale()||!this.connection.isOpen())&&(s.log(`ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = ${document.visibilityState}`),this.connection.reopen())},200)}};f.staleThreshold=6;f.reconnectionBackoffRate=.15;var I={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart",remote:"remote"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},{message_types:d,protocols:x}=I,X=x.slice(0,x.length-1),j=[].indexOf,m=class{constructor(e){this.open=this.open.bind(this),this.consumer=e,this.subscriptions=this.consumer.subscriptions,this.monitor=new f(this),this.disconnected=!0}send(e){return this.isOpen()?(this.webSocket.send(JSON.stringify(e)),!0):!1}open(){if(this.isActive())return s.log(`Attempted to open WebSocket, but existing socket is ${this.getState()}`),!1;{let e=[...x,...this.consumer.subprotocols||[]];return s.log(`Opening WebSocket, current state is ${this.getState()}, subprotocols: ${e}`),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new C.WebSocket(this.consumer.url,e),this.installEventHandlers(),this.monitor.start(),!0}}close({allowReconnect:e}={allowReconnect:!0}){if(e||this.monitor.stop(),this.isOpen())return this.webSocket.close()}reopen(){if(s.log(`Reopening WebSocket, current state is ${this.getState()}`),this.isActive())try{return this.close()}catch(e){s.log("Failed to reopen WebSocket",e)}finally{s.log(`Reopening WebSocket in ${this.constructor.reopenDelay}ms`),setTimeout(this.open,this.constructor.reopenDelay)}else return this.open()}getProtocol(){if(this.webSocket)return this.webSocket.protocol}isOpen(){return this.isState("open")}isActive(){return this.isState("open","connecting")}triedToReconnect(){return this.monitor.reconnectAttempts>0}isProtocolSupported(){return j.call(X,this.getProtocol())>=0}isState(...e){return j.call(e,this.getState())>=0}getState(){if(this.webSocket){for(let e in C.WebSocket)if(C.WebSocket[e]===this.webSocket.readyState)return e.toLowerCase()}return null}installEventHandlers(){for(let e in this.events){let n=this.events[e].bind(this);this.webSocket[`on${e}`]=n}}uninstallEventHandlers(){for(let e in this.events)this.webSocket[`on${e}`]=function(){}}};m.reopenDelay=500;m.prototype.events={message(t){if(!this.isProtocolSupported())return;let{identifier:e,message:n,reason:o,reconnect:r,type:c}=JSON.parse(t.data);switch(this.monitor.recordMessage(),c){case d.welcome:return this.triedToReconnect()&&(this.reconnectAttempted=!0),this.monitor.recordConnect(),this.subscriptions.reload();case d.disconnect:return s.log(`Disconnecting. Reason: ${o}`),this.close({allowReconnect:r});case d.ping:return null;case d.confirmation:return this.subscriptions.confirmSubscription(e),this.reconnectAttempted?(this.reconnectAttempted=!1,this.subscriptions.notify(e,"connected",{reconnected:!0})):this.subscriptions.notify(e,"connected",{reconnected:!1});case d.rejection:return this.subscriptions.reject(e);default:return this.subscriptions.notify(e,"received",n)}},open(){if(s.log(`WebSocket onopen event, using '${this.getProtocol()}' subprotocol`),this.disconnected=!1,!this.isProtocolSupported())return s.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close(t){if(s.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error(){s.log("WebSocket onerror event")}};var Y=function(t,e){if(e!=null)for(let n in e){let o=e[n];t[n]=o}return t},N=class{constructor(e,n={},o){this.consumer=e,this.identifier=JSON.stringify(n),Y(this,o)}perform(e,n={}){return n.action=e,this.send(n)}send(e){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(e)})}unsubscribe(){return this.consumer.subscriptions.remove(this)}},$=class{constructor(e){this.subscriptions=e,this.pendingSubscriptions=[]}guarantee(e){this.pendingSubscriptions.indexOf(e)==-1?(s.log(`SubscriptionGuarantor guaranteeing ${e.identifier}`),this.pendingSubscriptions.push(e)):s.log(`SubscriptionGuarantor already guaranteeing ${e.identifier}`),this.startGuaranteeing()}forget(e){s.log(`SubscriptionGuarantor forgetting ${e.identifier}`),this.pendingSubscriptions=this.pendingSubscriptions.filter(n=>n!==e)}startGuaranteeing(){this.stopGuaranteeing(),this.retrySubscribing()}stopGuaranteeing(){clearTimeout(this.retryTimeout)}retrySubscribing(){this.retryTimeout=setTimeout(()=>{this.subscriptions&&typeof this.subscriptions.subscribe=="function"&&this.pendingSubscriptions.map(e=>{s.log(`SubscriptionGuarantor resubscribing ${e.identifier}`),this.subscriptions.subscribe(e)})},500)}},P=class{constructor(e){this.consumer=e,this.guarantor=new $(this),this.subscriptions=[]}create(e,n){let o=e,r=typeof o=="object"?o:{channel:o},c=new N(this.consumer,r,n);return this.add(c)}add(e){return this.subscriptions.push(e),this.consumer.ensureActiveConnection(),this.notify(e,"initialized"),this.subscribe(e),e}remove(e){return this.forget(e),this.findAll(e.identifier).length||this.sendCommand(e,"unsubscribe"),e}reject(e){return this.findAll(e).map(n=>(this.forget(n),this.notify(n,"rejected"),n))}forget(e){return this.guarantor.forget(e),this.subscriptions=this.subscriptions.filter(n=>n!==e),e}findAll(e){return this.subscriptions.filter(n=>n.identifier===e)}reload(){return this.subscriptions.map(e=>this.subscribe(e))}notifyAll(e,...n){return this.subscriptions.map(o=>this.notify(o,e,...n))}notify(e,n,...o){let r;return typeof e=="string"?r=this.findAll(e):r=[e],r.map(c=>typeof c[n]=="function"?c[n](...o):void 0)}subscribe(e){this.sendCommand(e,"subscribe")&&this.guarantor.guarantee(e)}confirmSubscription(e){s.log(`Subscription confirmed ${e}`),this.findAll(e).map(n=>this.guarantor.forget(n))}sendCommand(e,n){let{identifier:o}=e;return this.consumer.send({command:n,identifier:o})}},T=class{constructor(e){this._url=e,this.subscriptions=new P(this),this.connection=new m(this),this.subprotocols=[]}get url(){return ee(this._url)}send(e){return this.connection.send(e)}connect(){return this.connection.open()}disconnect(){return this.connection.close({allowReconnect:!1})}ensureActiveConnection(){if(!this.connection.isActive())return this.connection.open()}addSubProtocol(e){this.subprotocols=[...this.subprotocols,e]}};function ee(t){if(typeof t=="function"&&(t=t()),t&&!/^wss?:/i.test(t)){let e=document.createElement("a");return e.href=t,e.href=e.href,e.protocol=e.protocol.replace("http","ws"),e.href}else return t}function B(t=te("url")||I.default_mount_path){return new T(t)}function te(t){let e=document.head.querySelector(`meta[name='action-cable-${t}']`);if(e)return e.getAttribute("content")}var y=B();function ne(t){let e=(0,k.useRef)(()=>{});e.current=n=>{t(W(n))},(0,k.useEffect)(()=>{let n=y.subscriptions.create({channel:"DirectConversationsChannel"},{connected:()=>{},disconnected:()=>{},received:o=>{e.current(o.conversation)}});return()=>{n.unsubscribe()}},[])}var g=i(u(),1);function oe(){let[t,e]=(0,g.useState)([]),[n,o]=(0,g.useState)(!0);return(0,g.useEffect)(()=>{(async()=>{let r=await b("/conversations",{type:"group"});r.success&&e(_(r.data)),o(!1)})()},[]),{setGroupChannels:e,groupChannels:t,groupChannelsLoading:n}}var w=i(u(),1);function se(t){let e=(0,w.useRef)(()=>{});e.current=n=>{t(n)},(0,w.useEffect)(()=>{let n=y.subscriptions.create({channel:"GroupConversationsChannel"},{connected:()=>{},disconnected:()=>{},received:o=>{e.current(L(o.conversation))}});return()=>{n.unsubscribe()}},[])}export{F as a,Z as b,K as c,z as d,Q as e,y as f,ne as g,oe as h,se as i,J as j,q as k};
